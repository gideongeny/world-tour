{% extends "base.html" %}

{% block title %}Live Seat Map - World Tour{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Hero Section -->
    <div class="hero-section bg-gradient-primary text-white py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4">Live Seat Map</h1>
                    <p class="lead mb-4">Choose your perfect seat with real-time availability. See exactly what's available and get the best price for your preferred location.</p>
                    <div class="flight-info-card bg-white text-dark p-3 rounded">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Flight</small>
                                <div class="fw-bold" id="flightNumber">BA123</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Aircraft</small>
                                <div class="fw-bold" id="aircraftType">Boeing 787-9</div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">From</small>
                                <div class="fw-bold" id="origin">LHR</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">To</small>
                                <div class="fw-bold" id="destination">JFK</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="real-time-indicator text-center">
                        <div class="pulse-dot"></div>
                        <p class="text-white-50">Live updates every 30 seconds</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seat Map Interface -->
    <div class="container py-5">
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-plane me-2"></i>Seat Selection</h4>
                        <div class="seat-legend">
                            <span class="legend-item"><span class="seat-available"></span> Available</span>
                            <span class="legend-item"><span class="seat-selected"></span> Selected</span>
                            <span class="legend-item"><span class="seat-occupied"></span> Occupied</span>
                            <span class="legend-item"><span class="seat-premium"></span> Premium</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Aircraft Layout -->
                        <div class="aircraft-layout">
                            <!-- First Class Section -->
                            <div class="cabin-section first-class">
                                <h5 class="cabin-title">First Class</h5>
                                <div class="seat-grid" id="firstClassSeats">
                                    <!-- Seats will be generated by JavaScript -->
                                </div>
                            </div>

                            <!-- Business Class Section -->
                            <div class="cabin-section business-class">
                                <h5 class="cabin-title">Business Class</h5>
                                <div class="seat-grid" id="businessClassSeats">
                                    <!-- Seats will be generated by JavaScript -->
                                </div>
                            </div>

                            <!-- Economy Class Section -->
                            <div class="cabin-section economy-class">
                                <h5 class="cabin-title">Economy Class</h5>
                                <div class="seat-grid" id="economyClassSeats">
                                    <!-- Seats will be generated by JavaScript -->
                                </div>
                            </div>

                            <!-- Exit Rows -->
                            <div class="exit-row-indicator">
                                <span class="exit-label">Exit Row</span>
                            </div>
                        </div>

                        <!-- Seat Details -->
                        <div class="seat-details mt-4" id="seatDetails" style="display: none;">
                            <h6>Selected Seat Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Seat:</strong> <span id="selectedSeatNumber"></span></p>
                                    <p><strong>Class:</strong> <span id="selectedSeatClass"></span></p>
                                    <p><strong>Price:</strong> <span id="selectedSeatPrice"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Features:</strong> <span id="selectedSeatFeatures"></span></p>
                                    <p><strong>Legroom:</strong> <span id="selectedSeatLegroom"></span></p>
                                    <p><strong>Window/Aisle:</strong> <span id="selectedSeatPosition"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Pricing Panel -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Dynamic Pricing</h5>
                    </div>
                    <div class="card-body">
                        <div class="pricing-info">
                            <div class="price-item">
                                <span class="seat-type">Economy</span>
                                <span class="price" id="economyPrice">$450</span>
                                <span class="trend up">+5%</span>
                            </div>
                            <div class="price-item">
                                <span class="seat-type">Premium Economy</span>
                                <span class="price" id="premiumEconomyPrice">$650</span>
                                <span class="trend up">+3%</span>
                            </div>
                            <div class="price-item">
                                <span class="seat-type">Business</span>
                                <span class="price" id="businessPrice">$1,200</span>
                                <span class="trend down">-2%</span>
                            </div>
                            <div class="price-item">
                                <span class="seat-type">First Class</span>
                                <span class="price" id="firstClassPrice">$2,500</span>
                                <span class="trend stable">0%</span>
                            </div>
                        </div>
                        <div class="demand-indicator mt-3">
                            <small class="text-muted">Demand Level:</small>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: 75%"></div>
                            </div>
                            <small class="text-muted">High demand - prices may increase</small>
                        </div>
                    </div>
                </div>

                <!-- Selected Seats -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Selected Seats</h5>
                    </div>
                    <div class="card-body">
                        <div id="selectedSeatsList">
                            <p class="text-muted">No seats selected</p>
                        </div>
                        <div class="total-price mt-3" id="totalPrice" style="display: none;">
                            <h6>Total: <span id="totalAmount">$0</span></h6>
                        </div>
                    </div>
                </div>

                <!-- Seat Recommendations -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>AI Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div id="seatRecommendations">
                            <div class="recommendation-item">
                                <div class="seat-preview">12A</div>
                                <div class="recommendation-details">
                                    <strong>Best Value</strong>
                                    <p class="mb-1">Window seat with extra legroom</p>
                                    <small class="text-success">$50 less than similar seats</small>
                                </div>
                            </div>
                            <div class="recommendation-item">
                                <div class="seat-preview">15C</div>
                                <div class="recommendation-details">
                                    <strong>Quiet Zone</strong>
                                    <p class="mb-1">Aisle seat away from engines</p>
                                    <small class="text-info">Perfect for sleeping</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow">
                    <div class="card-body">
                        <button class="btn btn-primary w-100 mb-2" id="confirmSeatsBtn" disabled>
                            <i class="fas fa-check me-2"></i>Confirm Seats
                        </button>
                        <button class="btn btn-outline-secondary w-100" id="clearSeatsBtn">
                            <i class="fas fa-times me-2"></i>Clear Selection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Updates -->
    <div class="bg-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="real-time-updates">
                        <h5><i class="fas fa-sync-alt me-2"></i>Real-time Updates</h5>
                        <div class="update-feed" id="updateFeed">
                            <div class="update-item">
                                <span class="time">14:32</span>
                                <span class="message">Seat 12A just became available</span>
                            </div>
                            <div class="update-item">
                                <span class="time">14:30</span>
                                <span class="message">Price increased for Economy seats</span>
                            </div>
                            <div class="update-item">
                                <span class="time">14:28</span>
                                <span class="message">New passenger selected seat 15B</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.pulse-dot {
    width: 20px;
    height: 20px;
    background: #28a745;
    border-radius: 50%;
    margin: 0 auto 10px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.aircraft-layout {
    position: relative;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.cabin-section {
    margin-bottom: 30px;
}

.cabin-title {
    color: #495057;
    font-size: 1.1rem;
    margin-bottom: 15px;
    padding-bottom: 5px;
    border-bottom: 2px solid #dee2e6;
}

.seat-grid {
    display: grid;
    gap: 8px;
    margin-bottom: 20px;
}

.first-class .seat-grid {
    grid-template-columns: repeat(4, 1fr);
}

.business-class .seat-grid {
    grid-template-columns: repeat(6, 1fr);
}

.economy-class .seat-grid {
    grid-template-columns: repeat(9, 1fr);
}

.seat {
    width: 40px;
    height: 40px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.seat:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.seat-available {
    background: #28a745;
    color: white;
}

.seat-selected {
    background: #007bff;
    color: white;
    border-color: #0056b3;
}

.seat-occupied {
    background: #dc3545;
    color: white;
    cursor: not-allowed;
}

.seat-premium {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    color: white;
    border-color: #e0a800;
}

.seat-legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

.legend-item span {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.seat-available {
    background: #28a745;
}

.seat-selected {
    background: #007bff;
}

.seat-occupied {
    background: #dc3545;
}

.seat-premium {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.exit-row-indicator {
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
}

.exit-label {
    color: #856404;
    font-weight: bold;
}

.pricing-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.price-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f8f9fa;
}

.price-item:last-child {
    border-bottom: none;
}

.seat-type {
    font-weight: 500;
}

.price {
    font-weight: bold;
    color: #28a745;
}

.trend {
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 4px;
}

.trend.up {
    background: #d4edda;
    color: #155724;
}

.trend.down {
    background: #f8d7da;
    color: #721c24;
}

.trend.stable {
    background: #e2e3e5;
    color: #383d41;
}

.recommendation-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid #f8f9fa;
}

.recommendation-item:last-child {
    border-bottom: none;
}

.seat-preview {
    width: 40px;
    height: 40px;
    background: #007bff;
    color: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
}

.recommendation-details {
    flex: 1;
}

.recommendation-details strong {
    color: #495057;
}

.update-feed {
    max-height: 200px;
    overflow-y: auto;
}

.update-item {
    display: flex;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #f8f9fa;
    font-size: 0.9rem;
}

.update-item:last-child {
    border-bottom: none;
}

.update-item .time {
    color: #6c757d;
    font-weight: 500;
    min-width: 50px;
}

.update-item .message {
    color: #495057;
}

@media (max-width: 768px) {
    .seat {
        width: 35px;
        height: 35px;
        font-size: 0.7rem;
    }
    
    .economy-class .seat-grid {
        grid-template-columns: repeat(6, 1fr);
    }
    
    .business-class .seat-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .first-class .seat-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<script>
class LiveSeatMap {
    constructor() {
        this.selectedSeats = new Set();
        this.seatData = {};
        this.prices = {
            economy: 450,
            premiumEconomy: 650,
            business: 1200,
            firstClass: 2500
        };
        this.init();
    }

    init() {
        this.generateSeats();
        this.bindEvents();
        this.startRealTimeUpdates();
        this.updatePrices();
    }

    generateSeats() {
        // Generate First Class seats (4 seats per row, 2 rows)
        this.generateSeatSection('firstClassSeats', 'firstClass', 2, 4, 'A', 'D');
        
        // Generate Business Class seats (6 seats per row, 4 rows)
        this.generateSeatSection('businessClassSeats', 'business', 4, 6, 'A', 'F');
        
        // Generate Economy Class seats (9 seats per row, 20 rows)
        this.generateSeatSection('economyClassSeats', 'economy', 20, 9, 'A', 'I');
    }

    generateSeatSection(containerId, seatClass, rows, seatsPerRow, startCol, endCol) {
        const container = document.getElementById(containerId);
        const columns = this.getColumnRange(startCol, endCol);
        
        for (let row = 1; row <= rows; row++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'seat-row';
            rowDiv.style.display = 'grid';
            rowDiv.style.gridTemplateColumns = `repeat(${seatsPerRow}, 1fr)`;
            rowDiv.style.gap = '8px';
            rowDiv.style.marginBottom = '8px';
            
            columns.forEach((col, index) => {
                const seatNumber = `${row}${col}`;
                const seat = this.createSeat(seatNumber, seatClass);
                rowDiv.appendChild(seat);
                
                // Store seat data
                this.seatData[seatNumber] = {
                    class: seatClass,
                    price: this.getSeatPrice(seatClass, row, col),
                    features: this.getSeatFeatures(seatClass, row, col),
                    legroom: this.getSeatLegroom(seatClass, row, col),
                    position: this.getSeatPosition(col)
                };
            });
            
            container.appendChild(rowDiv);
        }
    }

    getColumnRange(start, end) {
        const columns = [];
        for (let i = start.charCodeAt(0); i <= end.charCodeAt(0); i++) {
            columns.push(String.fromCharCode(i));
        }
        return columns;
    }

    createSeat(seatNumber, seatClass) {
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.textContent = seatNumber;
        seat.dataset.seatNumber = seatNumber;
        seat.dataset.seatClass = seatClass;
        
        // Randomly set some seats as occupied
        if (Math.random() < 0.3) {
            seat.classList.add('seat-occupied');
            seat.classList.remove('seat-available');
        } else {
            seat.classList.add('seat-available');
        }
        
        // Add premium indicator for some seats
        if (Math.random() < 0.2) {
            seat.classList.add('seat-premium');
        }
        
        return seat;
    }

    getSeatPrice(seatClass, row, col) {
        let basePrice = this.prices[seatClass];
        
        // Premium seats cost more
        if (col === 'A' || col === 'F' || col === 'I') {
            basePrice += 50; // Window seats
        }
        
        // Exit row seats cost more
        if (row === 12 || row === 13) {
            basePrice += 100;
        }
        
        // Front rows cost more
        if (row <= 5) {
            basePrice += 25;
        }
        
        return basePrice;
    }

    getSeatFeatures(seatClass, row, col) {
        const features = [];
        
        if (seatClass === 'firstClass') {
            features.push('Lie-flat bed', 'Direct aisle access', 'Premium dining');
        } else if (seatClass === 'business') {
            features.push('Reclining seat', 'Power outlet', 'Priority boarding');
        } else {
            features.push('Standard seat');
            if (col === 'A' || col === 'F' || col === 'I') {
                features.push('Window view');
            }
            if (row === 12 || row === 13) {
                features.push('Extra legroom');
            }
        }
        
        return features.join(', ');
    }

    getSeatLegroom(seatClass, row, col) {
        if (seatClass === 'firstClass') return '78 inches';
        if (seatClass === 'business') return '60 inches';
        if (row === 12 || row === 13) return '34 inches';
        return '31 inches';
    }

    getSeatPosition(col) {
        if (col === 'A' || col === 'F' || col === 'I') return 'Window';
        if (col === 'C' || col === 'D' || col === 'G') return 'Aisle';
        return 'Middle';
    }

    bindEvents() {
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('seat') && !e.target.classList.contains('seat-occupied')) {
                this.toggleSeat(e.target);
            }
        });

        document.getElementById('confirmSeatsBtn').addEventListener('click', () => {
            this.confirmSeats();
        });

        document.getElementById('clearSeatsBtn').addEventListener('click', () => {
            this.clearSelection();
        });
    }

    toggleSeat(seatElement) {
        const seatNumber = seatElement.dataset.seatNumber;
        
        if (this.selectedSeats.has(seatNumber)) {
            this.selectedSeats.delete(seatNumber);
            seatElement.classList.remove('seat-selected');
            seatElement.classList.add('seat-available');
        } else {
            this.selectedSeats.add(seatNumber);
            seatElement.classList.remove('seat-available');
            seatElement.classList.add('seat-selected');
        }
        
        this.updateSelectedSeatsList();
        this.updateTotalPrice();
        this.updateConfirmButton();
    }

    updateSelectedSeatsList() {
        const container = document.getElementById('selectedSeatsList');
        const totalPrice = document.getElementById('totalPrice');
        
        if (this.selectedSeats.size === 0) {
            container.innerHTML = '<p class="text-muted">No seats selected</p>';
            totalPrice.style.display = 'none';
            document.getElementById('seatDetails').style.display = 'none';
        } else {
            let html = '';
            this.selectedSeats.forEach(seatNumber => {
                const seatData = this.seatData[seatNumber];
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${seatNumber}</strong>
                            <small class="text-muted d-block">${seatData.class}</small>
                        </div>
                        <div class="text-end">
                            <strong>$${seatData.price}</strong>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            totalPrice.style.display = 'block';
            
            // Show details for last selected seat
            const lastSeat = Array.from(this.selectedSeats).pop();
            this.showSeatDetails(lastSeat);
        }
    }

    showSeatDetails(seatNumber) {
        const seatData = this.seatData[seatNumber];
        const detailsDiv = document.getElementById('seatDetails');
        
        document.getElementById('selectedSeatNumber').textContent = seatNumber;
        document.getElementById('selectedSeatClass').textContent = seatData.class;
        document.getElementById('selectedSeatPrice').textContent = `$${seatData.price}`;
        document.getElementById('selectedSeatFeatures').textContent = seatData.features;
        document.getElementById('selectedSeatLegroom').textContent = seatData.legroom;
        document.getElementById('selectedSeatPosition').textContent = seatData.position;
        
        detailsDiv.style.display = 'block';
    }

    updateTotalPrice() {
        let total = 0;
        this.selectedSeats.forEach(seatNumber => {
            total += this.seatData[seatNumber].price;
        });
        document.getElementById('totalAmount').textContent = `$${total}`;
    }

    updateConfirmButton() {
        const button = document.getElementById('confirmSeatsBtn');
        button.disabled = this.selectedSeats.size === 0;
    }

    clearSelection() {
        this.selectedSeats.clear();
        document.querySelectorAll('.seat-selected').forEach(seat => {
            seat.classList.remove('seat-selected');
            seat.classList.add('seat-available');
        });
        this.updateSelectedSeatsList();
        this.updateTotalPrice();
        this.updateConfirmButton();
    }

    confirmSeats() {
        if (this.selectedSeats.size === 0) return;
        
        const seats = Array.from(this.selectedSeats);
        const total = seats.reduce((sum, seat) => sum + this.seatData[seat].price, 0);
        
        // Show confirmation modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Seat Selection</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>You have selected the following seats:</p>
                        <ul>
                            ${seats.map(seat => `<li>${seat} - $${this.seatData[seat].price}</li>`).join('')}
                        </ul>
                        <p><strong>Total: $${total}</strong></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="window.location.href='/payment'">Proceed to Payment</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        new bootstrap.Modal(modal).show();
    }

    startRealTimeUpdates() {
        setInterval(() => {
            this.updatePrices();
            this.addUpdateMessage();
        }, 30000); // Update every 30 seconds
    }

    updatePrices() {
        // Simulate price changes
        Object.keys(this.prices).forEach(seatClass => {
            const change = (Math.random() - 0.5) * 0.1; // ±5% change
            this.prices[seatClass] = Math.round(this.prices[seatClass] * (1 + change));
        });
        
        // Update price display
        document.getElementById('economyPrice').textContent = `$${this.prices.economy}`;
        document.getElementById('premiumEconomyPrice').textContent = `$${this.prices.premiumEconomy}`;
        document.getElementById('businessPrice').textContent = `$${this.prices.business}`;
        document.getElementById('firstClassPrice').textContent = `$${this.prices.firstClass}`;
    }

    addUpdateMessage() {
        const messages = [
            'Seat availability updated',
            'Price adjustment applied',
            'New passenger selections detected',
            'Demand level changed',
            'Premium seats now available'
        ];
        
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
        
        const updateFeed = document.getElementById('updateFeed');
        const updateItem = document.createElement('div');
        updateItem.className = 'update-item';
        updateItem.innerHTML = `
            <span class="time">${time}</span>
            <span class="message">${randomMessage}</span>
        `;
        
        updateFeed.insertBefore(updateItem, updateFeed.firstChild);
        
        // Remove old updates if too many
        if (updateFeed.children.length > 10) {
            updateFeed.removeChild(updateFeed.lastChild);
        }
    }
}

// Initialize live seat map when page loads
document.addEventListener('DOMContentLoaded', function() {
    new LiveSeatMap();
});
</script>
{% endblock %} 